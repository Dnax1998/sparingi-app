<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Umawianie sparingu ‚Äì ZgranyTrener.pl</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../style-profil.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>

    <style>
      /* --- bazowy wyglƒÖd (bez zmian) --- */
      body {
        margin: 0;
        font-family: "Montserrat", sans-serif;
        background: url("profil/background.jpg") no-repeat center center fixed;
        background-size: cover;
        color: #fff;
      }
      header .logo {
        position: absolute;
        top: 15px;
        left: 25px;
        display: flex;
        align-items: center;
        z-index: 5;
      }
      header .logo img { height: 48px; }
      header .logo span { margin-left: 10px; font-weight: 700; font-size: 18px; }

      .page-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 80px 5%;
        gap: 40px;
        flex-wrap: wrap;
      }

      .left-side {
        flex: 1 1 520px;
        min-width: 320px;
        background: rgba(0, 0, 0, 0.45);
        padding: 30px;
        border-radius: 20px;
        height: 540px;
        overflow-y: auto;
        margin-top: 120px;
      }

      .filters {
        display: grid;
        grid-template-columns: 1.2fr 0.9fr 0.9fr 0.9fr 1fr;
        gap: 10px;
        margin: 18px 0 20px 0;
      }

      .filters input,
      .filters select {
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        outline: none;
        font-size: 14px;
      }

      .match-item {
        background: rgba(255, 255, 255, 0.08);
        margin-bottom: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .match-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .match-actions button {
        border: none;
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
      }

      .details-btn {
        background: #0ea5e9;
        color: #fff;
      }

      .accept-btn {
        background: #e3342f;
        color: #fff;
      }

      .details-btn:hover { filter: brightness(1.05); }
      .accept-btn:hover { background: #b91c1c; }

      .confirmation {
        background: #1db954;
        padding: 10px;
        border-radius: 8px;
        margin-top: 12px;
        text-align: center;
        display: none;
      }

      /* modal, formularz itd. bez zmian ‚Äî zostajƒÖ takie jak wcze≈õniej */
    </style>
  </head>

  <body>
    <header>
      <div class="logo">
        <img src="profil/logo.png" alt="Logo" />
        <span>ZgranyTrener.pl</span>
      </div>
    </header>

    <main>
      <div class="page-container">
        <section class="left-side">
          <h2>Og√≥lne sparingi</h2>
          <div class="filters" id="filters">
            <input id="f-team" type="text" placeholder="Nazwa dru≈ºyny‚Ä¶" />
            <select id="f-category">
              <option value="">Kategoria</option>
              <option>U6</option><option>U7</option><option>U8</option>
              <option>U9</option><option>U10</option><option>U11</option>
              <option>U12</option><option>U13</option><option>U14</option>
              <option>U15</option><option>U16</option><option>U17</option>
              <option>U18</option><option>U19</option>
            </select>
            <select id="f-level">
              <option value="">Poziom</option>
              <option>Rekreacja</option>
              <option>Podstawowy</option>
              <option>≈öredniozaawansowany</option>
              <option>Zaawansowany</option>
            </select>
            <input id="f-date" type="date" />
            <select id="f-type">
              <option value="">Typ meczu</option>
              <option>Domowy</option>
              <option>Wyjazdowy</option>
            </select>
          </div>
          <div id="matches-list"></div>
        </section>

        <!-- PRAWA STRONA (formularz, bez zmian) -->
        <section class="form-container">
          <h1>Um√≥w sparing</h1>
          <form id="match-form">
            <!-- ... (ca≈Çy Tw√≥j formularz zostaje taki sam jak w poprzedniej wersji) ... -->
          </form>
          <div class="confirmation" id="confirmation">‚úÖ Sparing zosta≈Ç zapisany!</div>
        </section>
      </div>
    </main>

    <!-- Modal (bez zmian) -->
    <div class="modal" id="details-modal" aria-hidden="true">
      <div class="modal-card">
        <h3 id="md-title">Szczeg√≥≈Çy sparingu</h3>
        <div class="modal-row" id="md-team"></div>
        <div class="modal-row" id="md-category"></div>
        <div class="modal-row" id="md-level"></div>
        <div class="modal-row" id="md-type"></div>
        <div class="modal-row" id="md-datetime"></div>
        <div class="modal-row" id="md-location"></div>
        <div class="modal-row" id="md-notes"></div>
        <div class="modal-actions">
          <button class="btn-secondary" id="md-close">Zamknij</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore, collection, doc, getDoc, addDoc, deleteDoc, onSnapshot, orderBy, query
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBXwR3VojWtQLA6FsXj2pVQsSTWNNAUhb0",
        authDomain: "sparingi-app.firebaseapp.com",
        projectId: "sparingi-app",
        storageBucket: "sparingi-app.firebasestorage.app",
        messagingSenderId: "293859421755",
        appId: "1:293859421755:web:e98887fdc5fb4a79aef61e"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const matchesList = document.getElementById("matches-list");
      let allMatches = [];
      let currentUser = null;
      let currentClub = "";

      // --- Funkcja renderujƒÖca listƒô ---
      function renderList(list) {
        matchesList.innerHTML = "";
        if (!list.length) {
          matchesList.innerHTML = "<p>Brak sparing√≥w.</p>";
          return;
        }

        list.forEach(({ id, data }) => {
          const div = document.createElement("div");
          div.classList.add("match-item");

          const main = document.createElement("div");
          main.classList.add("match-main");
          main.innerHTML = `
            <strong>${data.team}</strong> (${data.category || "-"})<br>
            üèÜ ${data.level || "-"} | üèÅ ${data.matchType || "-"}<br>
            üìÖ ${data.date || "-"} ‚è∞ ${data.time || "-"}<br>
            ${data.location ? "üìç " + data.location + "<br>" : ""}
          `;

          const actions = document.createElement("div");
          actions.classList.add("match-actions");

          const detailsBtn = document.createElement("button");
          detailsBtn.textContent = "Szczeg√≥≈Çy";
          detailsBtn.classList.add("details-btn");
          detailsBtn.onclick = () => showDetails(data);

          const acceptBtn = document.createElement("button");
          acceptBtn.textContent = "Zaakceptuj";
          acceptBtn.classList.add("accept-btn");
          acceptBtn.onclick = () => acceptMatch(id, data);

          actions.appendChild(detailsBtn);
          actions.appendChild(acceptBtn);

          div.appendChild(main);
          div.appendChild(actions);
          matchesList.appendChild(div);
        });
      }

      // --- Akceptacja sparingu ---
      async function acceptMatch(id, data) {
        if (!currentUser) return alert("Musisz byƒá zalogowany, aby zaakceptowaƒá sparing.");

        const confirmed = confirm(`Czy na pewno chcesz zaakceptowaƒá sparing z dru≈ºynƒÖ ${data.team}?`);
        if (!confirmed) return;

        try {
          await addDoc(collection(db, "zaakceptowane_sparingi"), {
            ...data,
            acceptedBy: currentUser.uid,
            acceptedTeam: currentClub,
            acceptedAt: new Date().toISOString()
          });

          await deleteDoc(doc(db, "sparingi", id));

          alert("‚úÖ Sparing zosta≈Ç zaakceptowany!");
        } catch (err) {
          console.error("B≈ÇƒÖd przy akceptacji sparingu:", err);
          alert("‚ùå WystƒÖpi≈Ç b≈ÇƒÖd przy akceptacji sparingu.");
        }
      }

      // --- Modal szczeg√≥≈Ç√≥w (bez zmian) ---
      function showDetails(data) {
        document.getElementById("details-modal").classList.add("open");
        document.getElementById("md-title").textContent = `Szczeg√≥≈Çy: ${data.team}`;
        document.getElementById("md-team").textContent = `Dru≈ºyna: ${data.team}`;
        document.getElementById("md-category").textContent = `Kategoria: ${data.category}`;
        document.getElementById("md-level").textContent = `Poziom: ${data.level}`;
        document.getElementById("md-type").textContent = `Typ meczu: ${data.matchType}`;
        document.getElementById("md-datetime").textContent = `Data: ${data.date} ${data.time || ""}`;
        document.getElementById("md-location").textContent = `Lokalizacja: ${data.location || "-"}`;
        document.getElementById("md-notes").textContent = `Uwagi: ${data.notes || "-"}`;
      }

      document.getElementById("md-close").addEventListener("click", () => {
        document.getElementById("details-modal").classList.remove("open");
      });

      // --- Nas≈Çuch og√≥lnych sparing√≥w ---
      function listenMatches() {
        const qy = query(collection(db, "sparingi"), orderBy("date", "desc"));
        onSnapshot(qy, (snap) => {
          const arr = [];
          snap.forEach((d) => arr.push({ id: d.id, data: d.data() }));
          allMatches = arr;
          renderList(allMatches);
        });
      }

      // --- Start po zalogowaniu ---
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        currentUser = user;

        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            currentClub = userSnap.data().klub || userSnap.data().club || "Nieznany klub";
            document.getElementById("team").value = currentClub;
          }
        } catch (e) {
          console.warn("Nie uda≈Ço siƒô pobraƒá danych klubu.");
        }

        listenMatches();
      });
    </script>
  </body>
</html>
